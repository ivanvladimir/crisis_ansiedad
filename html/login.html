{% extends 'base.html' %}

{% block script %}
	<script>

    function getCookie(name) {
        const value = '; ' + document.cookie;
        const parts = value.split('; ' + name + '=');
        if (parts.length === 2) return parts.pop().split(';').shift();
    }

    async function createOrRetrieveUniqueId() {
        const existingId = getCookie('uniqueId');
        if (existingId) {
            const form = document.getElementById('user-form');
            form.action =`/cv/mar/${existingId}/`;
            return existingId;
        }
        const uniqueId = Math.floor(Math.random() * 1000000);
        document.cookie = `uniqueId=${uniqueId};`;
        const form = document.getElementById('user-form');
        form.action =`/cv/mar/${uniqueId}/`;
        return uniqueId;
    }

    function loadValuesFromCookies() {
        // Fetch all cookies and split into an array
        const cookieArray = document.cookie.split("; ");

        // Loop over the array and process each cookie
        cookieArray.forEach(cookie => {
            // Split each cookie into name and value
            const [name, value] = cookie.split("=");

            // Try to find an element in the form that has the same name as the cookie
            const inputElement = document.getElementsByName(name)[0];

            // If we found an element and it's an input, set its value to the value of the cookie
            if (inputElement && inputElement.tagName === 'input') {
                inputElement.value = decodeURIComponent(value);
            }
            if (inputElement && inputElement.tagName === 'select') {
                const colorSelect = document.getElementById(name);
                const blueOption = colorSelect.querySelector(`option[value="${value}"]`);
            }

        });
    }

    // When the form is submitted
    $('#user-form').on('submit', function(event) {
        event.preventDefault();

        const username = $('#username').val();
        const gender = $('input[name="gender"]:checked').val();

        document.cookie = `username=${username};`;
        document.cookie = `gender=${gender};`;

        uniqueId = createOrRetrieveUniqueId(username);
s
        form.submit();
    });

    window.onload = function() {
        loadValuesFromCookies();
        createOrRetrieveUniqueId();
    }
    </script>
{% endblock %}

{% block content %}
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-6">
                <h1 class="text-center">Informacción general</h1>
                <form id="user-form" method="POST">
                    <div class="form-group">
                        <label for="username">¿Nombre de usuario con el que te gustaría que Mar se dirigiera a ti?</label>
                        <input type="text" class="form-control" id="username" name="username">
                    </div>
                    <div class="form-group">
                        <label for="gender">¿Con qué género te identificas?</label>
                        <select name="gender" class="form-control" >
                            <label class="btn btn-secondary">
                                <option name="gender" id="genderMale" value="Male" autocomplete="off"> Hombre
                            </label>
                            <label class="btn btn-secondary">
                                <option id="genderFemale" value="Female" autocomplete="off"> Mujer
                            </label>
      						<label class="btn btn-secondary">
                                <option id="genderFemale" value="Other" autocomplete="off"> Otro
                            </label>
                        </select>
                    </div>
                    <button type="submit" class="btn btn-primary">Comenzar a chatear</button>
                </form>
            </div>
        </div>
    </div>
{% endblock %}
