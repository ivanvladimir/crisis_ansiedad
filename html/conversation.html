{% extends 'base.html' %}

{% block script %}
	<script type="text/javascript" charset="utf-8">
        $(document).ready(function(){
            namespace = '{{prefix}}';
            var msgCount = 1;
            var client_id = Date.now()
            var spk='USER';
            var port='{{port}}';
            var converter = new showdown.Converter();
            if(port.length>0){
                var ws = new WebSocket('{{protocol}}://{{server}}:{{port}}' + namespace+`${client_id}`);
            }else{
                var ws = new WebSocket('{{protocol}}://{{server}}' + namespace+`${client_id}`);
            }
            ws.addEventListener("open", (event) => {
                ws.send(JSON.stringify({'cmd':'start','conversation':"{{chat_name}}"}));
            });

            $('#send').click(function(e){sendMSG(e)});

            $('#msg_input').focus();

            function sleep(milliseconds) {
                  const date = Date.now();
                  let currentDate = null;
                  do {
                          currentDate = Date.now();
                        } while (currentDate - date < milliseconds);
            }

            function sendMSG(e) {
                var msg = String($('#msg_input').val());
                if(msg.trim().length>0){
                    ws.send(JSON.stringify({'cmd':'input completed','msg':msg}));
                    showUserMessage(msg,getCurrentTimestamp());
                    $('#msg_input').val('');
                    msgCount += 1;
      			    return false;
                }
    		}

            // Get the input field
            var input = document.getElementById("msg_input");

            // Execute a function when the user presses a key on the keyboard
            input.addEventListener("keypress", function(event) {
                  // If the user presses the "Enter" key on the keyboard
                  if (event.key === "Enter") {
                          // Cancel the default action, if needed
                          event.preventDefault();
                          // Trigger the button element with a click
                          document.getElementById("send").click();
                        }
            });

            ws.onmessage = function(event) {
				data=JSON.parse(event.data);
                // SAY
				if(data.cmd=="say"){
                    html = converter.makeHtml(data.msg);
                    showBotMessage(html,getCurrentTimestamp());
                    sleep(400);
                    //let utter = new SpeechSynthesisUtterance();
                    //utter.lang = 'es-MX';
                    //utter.text = data.msg;
                    //utter.volume = 0.5;
                    // speak
                    //window.speechSynthesis.speak(utter);
				};
            };
        });
    </script>
{% endblock %}

{% block content %}
	<div class="container">

		<div class="row padded_row">

				<div class="chat_window">

					<div class="top_menu">
                        <div class="title">SAM</div>
					</div>

					<!-- dynamically rendered -->
					<ul class="messages"></ul>

					<!-- input -->
					<div class="bottom_wrapper">
						<input id="msg_input" placeholder="Escribe aquÃ­"/>
                        <div id="send" class="app_button_1">Enviar</div>
					</div>
				</div>
		</div>

	</div>

{% endblock %}
